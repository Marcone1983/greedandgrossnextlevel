name: simple build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          
      - run: npm install --legacy-peer-deps
      
      # Fix namespace issue for react-native-fs
      - name: Fix react-native-fs namespace
        run: |
          echo "Fixing react-native-fs namespace issue..."
          RNFS_BUILD_GRADLE="node_modules/react-native-fs/android/build.gradle"
          if [ -f "$RNFS_BUILD_GRADLE" ]; then
            sed -i '/android {/a\    namespace "com.rnfs"' "$RNFS_BUILD_GRADLE"
          fi
      
      # Clear Gradle cache to avoid corruption issues
      - name: Clear Gradle Cache
        run: |
          rm -rf ~/.gradle/caches/
          rm -rf ~/.gradle/wrapper/
      
      # Create gradle.properties with proper memory settings
      - name: Setup Gradle Properties
        run: |
          mkdir -p android
          cat > android/gradle.properties << EOF
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.daemon=false
          android.useAndroidX=true
          android.enableJetifier=true
          EOF
      
      # Dai permessi di esecuzione a gradlew
      - run: chmod +x android/gradlew
      
      # Esegui il build dalla directory android con retry
      - name: Build Android
        run: |
          cd android
          # Prova fino a 3 volte in caso di errori di download
          for i in 1 2 3; do
            ./gradlew bundleRelease --stacktrace --no-daemon && break || {
              echo "Build attempt $i failed, retrying..."
              ./gradlew --stop
              rm -rf ~/.gradle/caches/jars-9/
              sleep 10
            }
          done
      
      # Upload APK/AAB artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-build
          path: |
            android/app/build/outputs/bundle/release/*.aab
            android/app/build/outputs/apk/release/*.apk
          retention-days: 7
