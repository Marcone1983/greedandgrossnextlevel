name: Build APK

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm install
        rm -rf node_modules/detox || true
        npm uninstall detox --save-dev || true
        
    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Install dependencies with fixed versions
      run: |
        # Use React Native 0.79.0 (latest stable)
        npm install
        # Fix version mismatch
        ./scripts/fix-version-mismatch.sh
        # Publish React Native to local repository
        ./scripts/publish-react-native.sh
        
    - name: Find Android directory
      run: |
        if [ -d "android" ]; then
          echo "ANDROID_DIR=android" >> $GITHUB_ENV
        elif [ -d "GreedGross" ]; then
          echo "ANDROID_DIR=GreedGross" >> $GITHUB_ENV
        else
          GRADLEW_PATH=$(find . -name "gradlew" -not -path "*/node_modules/*" | head -1)
          echo "ANDROID_DIR=$(dirname "$GRADLEW_PATH")" >> $GITHUB_ENV
        fi
        
    - name: Build all Android variants
      run: |
        cd "$ANDROID_DIR"
        chmod +x gradlew
        
        touch lasspath
        
        # Add React Native repositories before removing plugin
        sed -i '/repositories {/a\        maven { url("$rootDir/../node_modules/react-native/android") }\
        maven { url("$rootDir/../node_modules/jsc-android/dist") }\
        maven { url("$rootDir/../local-maven-repo") }' build.gradle
        
        # Fix in allprojects too
        sed -i '/allprojects {/,/}/ { /repositories {/a\        maven { url("$rootDir/../node_modules/react-native/android") }\
        maven { url("$rootDir/../node_modules/jsc-android/dist") }\
        maven { url("$rootDir/../local-maven-repo") }
        }' build.gradle
        
        sed -i '/com\.facebook\.react:react-native-gradle-plugin/d' build.gradle
        sed -i '/classpath.*react-native-gradle-plugin/d' build.gradle
        
        # Add buildConfig configuration for all subprojects (fixes lottie-react-native)
        if ! grep -q "buildFeatures" build.gradle; then
          echo "" >> build.gradle
          echo "allprojects {" >> build.gradle
          echo "    afterEvaluate { project ->" >> build.gradle
          echo "        if (project.hasProperty('android')) {" >> build.gradle
          echo "            android {" >> build.gradle
          echo "                buildFeatures {" >> build.gradle
          echo "                    buildConfig true" >> build.gradle
          echo "                }" >> build.gradle
          echo "                // Fix namespace for React Native modules" >> build.gradle
          echo "                if (!project.android.hasProperty('namespace') || project.android.namespace == null) {" >> build.gradle
          echo "                    namespace project.group ?: 'com.reactnative.' + project.name.replace('-', '')" >> build.gradle
          echo "                }" >> build.gradle
          echo "            }" >> build.gradle
          echo "        }" >> build.gradle
          echo "    }" >> build.gradle
          echo "}" >> build.gradle
        fi
        
        if [ ! -d "app" ]; then
          echo "Creating app module structure..."
          mkdir -p app/src/main/java
          mkdir -p app/src/main/res
          
          echo 'apply plugin: "com.android.application"' > app/build.gradle
          echo '' >> app/build.gradle
          echo 'android {' >> app/build.gradle
          echo '    compileSdkVersion 34' >> app/build.gradle
          echo '    buildToolsVersion "34.0.0"' >> app/build.gradle
          echo '    ' >> app/build.gradle
          echo '    buildFeatures {' >> app/build.gradle
          echo '        buildConfig true' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '    ' >> app/build.gradle
          echo '    defaultConfig {' >> app/build.gradle
          echo '        applicationId "com.greedgross"' >> app/build.gradle
          echo '        minSdkVersion 24' >> app/build.gradle
          echo '        targetSdkVersion 34' >> app/build.gradle
          echo '        versionCode 1' >> app/build.gradle
          echo '        versionName "1.0"' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '    ' >> app/build.gradle
          echo '    buildTypes {' >> app/build.gradle
          echo '        debug {' >> app/build.gradle
          echo '            debuggable true' >> app/build.gradle
          echo '        }' >> app/build.gradle
          echo '        release {' >> app/build.gradle
          echo '            minifyEnabled false' >> app/build.gradle
          echo '        }' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '}' >> app/build.gradle
          
          echo "include ':app'" >> settings.gradle
        else
          sed -i '/apply plugin: "com.facebook.react"/d' app/build.gradle
          if ! grep -q "compileSdkVersion" app/build.gradle; then
            sed -i '/android {/a\    compileSdkVersion 34' app/build.gradle
          fi
          if ! grep -q "buildConfig true" app/build.gradle; then
            sed -i '/android {/a\    buildFeatures {\n        buildConfig true\n    }' app/build.gradle
          fi
        fi
        
        echo "Available build tasks:"
        ./gradlew tasks | grep -i assemble
        
        echo "Building Debug APK..."
        ./gradlew assembleDebug --stacktrace
        
        echo "Building Release APK..."  
        ./gradlew assembleRelease --stacktrace
        
        echo "Building Debug AAB..."
        ./gradlew bundleDebug --stacktrace || true
        
        echo "Building Release AAB..."
        ./gradlew bundleRelease --stacktrace || true
        
    - uses: actions/upload-artifact@v4
      with:
        name: android-builds-complete
        path: |
          **/build/outputs/apk/debug/*.apk
          **/build/outputs/apk/release/*.apk
          **/build/outputs/bundle/debug/*.aab
          **/build/outputs/bundle/release/*.aab
