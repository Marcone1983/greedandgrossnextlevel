name: simple build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          
      - run: npm install --legacy-peer-deps
      
      - name: Fix react-native-fs namespace
        run: |
          RNFS_BUILD_GRADLE="node_modules/react-native-fs/android/build.gradle"
          if [ -f "$RNFS_BUILD_GRADLE" ]; then
            sed -i '/android {/a\    namespace "com.rnfs"' "$RNFS_BUILD_GRADLE"
          fi
      
      - name: Setup Gradle Properties
        run: |
          mkdir -p android
          cat > android/gradle.properties << EOF
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.daemon=false
          android.useAndroidX=true
          android.enableJetifier=true
          EOF
      
      - run: chmod +x android/gradlew
      
      # Tentativo 1
      - name: Build Attempt 1
        id: attempt1
        continue-on-error: true
        run: |
          cd android
          ./gradlew bundleRelease --stacktrace --no-daemon 2>&1 | tee ../build_log_1.txt
      
      # Fix e Tentativo 2
      - name: Fix and Build Attempt 2
        if: steps.attempt1.outcome == 'failure'
        id: attempt2
        continue-on-error: true
        run: |
          cd android
          if grep -q "Failed to create Jar file" ../build_log_1.txt; then
            rm -rf ~/.gradle/caches/jars-*/
            ./gradlew --stop
          elif grep -q "Namespace not specified" ../build_log_1.txt; then
            MODULE=$(grep -B5 "Namespace not specified" ../build_log_1.txt | grep -oP "project ':\K[^']+" | head -1)
            if [ ! -z "$MODULE" ]; then
              sed -i "/android {/a\\    namespace \"com.${MODULE//-/.}\"" "../node_modules/$MODULE/android/build.gradle"
            fi
          fi
          ./gradlew bundleRelease --stacktrace --no-daemon 2>&1 | tee ../build_log_2.txt
      
      # Fix e Tentativo 3
      - name: Fix and Build Attempt 3
        if: steps.attempt2.outcome == 'failure'
        id: attempt3
        continue-on-error: true
        run: |
          cd android
          if grep -q "react-native-gesture-handler" ../build_log_2.txt; then
            sed -i '/android {/a\    namespace "com.swmansion.gesturehandler"' ../node_modules/react-native-gesture-handler/android/build.gradle || true
            rm -rf ~/.gradle/caches/
          elif grep -q "OutOfMemoryError" ../build_log_2.txt; then
            sed -i 's/-Xmx4096m/-Xmx6144m/g' gradle.properties
          fi
          ./gradlew bundleRelease --stacktrace --no-daemon 2>&1 | tee ../build_log_3.txt
      
      # Fix e Tentativo 4
      - name: Fix and Build Attempt 4
        if: steps.attempt3.outcome == 'failure'
        id: attempt4
        continue-on-error: true
        run: |
          cd android
          ./gradlew clean
          rm -rf ~/.gradle/caches/
          ./gradlew bundleRelease --stacktrace --no-daemon --refresh-dependencies 2>&1 | tee ../build_log_4.txt
      
      # Tentativo 5 finale
      - name: Final Build Attempt 5
        if: steps.attempt4.outcome == 'failure'
        run: |
          cd android
          find ../node_modules -name "build.gradle" -exec grep -l "minSdkVersion" {} \; | while read file; do
            sed -i 's/minSdkVersion [0-9]*/minSdkVersion 24/g' "$file"
          done
          ./gradlew --stop
          rm -rf build/ app/build/ ~/.gradle/caches/
          ./gradlew bundleRelease --stacktrace --no-daemon
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-build
          path: |
            android/app/build/outputs/bundle/release/*.aab
            android/app/build/outputs/apk/release/*.apk
            build_log_*.txt
          retention-days: 7
