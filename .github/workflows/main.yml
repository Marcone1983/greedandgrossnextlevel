name: simple build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          
      - run: npm install --legacy-peer-deps
      
      - name: Fix react-native-fs namespace
        run: |
          RNFS_BUILD_GRADLE="node_modules/react-native-fs/android/build.gradle"
          if [ -f "$RNFS_BUILD_GRADLE" ]; then
            sed -i '/android {/a\    namespace "com.rnfs"' "$RNFS_BUILD_GRADLE"
          fi
      
      - name: Setup Gradle Properties
        run: |
          mkdir -p android
          cat > android/gradle.properties << EOF
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.daemon=false
          android.useAndroidX=true
          android.enableJetifier=true
          EOF
      
      - run: chmod +x android/gradlew
      
      - name: Build with 5 attempts
        run: |
          cd android
          
          # Tentativo 1
          echo "::group::Build Attempt 1/5"
          ./gradlew bundleRelease --stacktrace --no-daemon 2>&1 | tee ../build_log.txt && exit 0 || echo "Failed attempt 1"
          echo "::endgroup::"
          
          # Fix per tentativo 2
          echo "::group::Fixing issues for attempt 2"
          if grep -q "Failed to create Jar file" ../build_log.txt; then
            rm -rf ~/.gradle/caches/jars-*/
            ./gradlew --stop
          elif grep -q "Namespace not specified" ../build_log.txt; then
            grep -B5 "Namespace not specified" ../build_log.txt | grep "project ':" | while read -r line; do
              MODULE=$(echo $line | sed "s/.*project ':\(.*\)'.*/\1/")
              MODULE_GRADLE="../node_modules/$MODULE/android/build.gradle"
              if [ -f "$MODULE_GRADLE" ] && ! grep -q "namespace" "$MODULE_GRADLE"; then
                NAMESPACE=$(echo $MODULE | sed 's/-/./g')
                sed -i "/android {/a\\    namespace \"com.${NAMESPACE}\"" "$MODULE_GRADLE"
              fi
            done
          fi
          echo "::endgroup::"
          
          # Tentativo 2
          echo "::group::Build Attempt 2/5"
          ./gradlew bundleRelease --stacktrace --no-daemon 2>&1 | tee ../build_log.txt && exit 0 || echo "Failed attempt 2"
          echo "::endgroup::"
          
          # Fix per tentativo 3
          echo "::group::Fixing issues for attempt 3"
          if grep -q "Failed to create Jar file" ../build_log.txt; then
            rm -rf ~/.gradle/caches/jars-*/
            ./gradlew --stop
          elif grep -q "Namespace not specified" ../build_log.txt; then
            grep -B5 "Namespace not specified" ../build_log.txt | grep "project ':" | while read -r line; do
              MODULE=$(echo $line | sed "s/.*project ':\(.*\)'.*/\1/")
              MODULE_GRADLE="../node_modules/$MODULE/android/build.gradle"
              if [ -f "$MODULE_GRADLE" ] && ! grep -q "namespace" "$MODULE_GRADLE"; then
                NAMESPACE=$(echo $MODULE | sed 's/-/./g')
                sed -i "/android {/a\\    namespace \"com.${NAMESPACE}\"" "$MODULE_GRADLE"
              fi
            done
          fi
          echo "::endgroup::"
          
          # Tentativo 3
          echo "::group::Build Attempt 3/5"
          ./gradlew bundleRelease --stacktrace --no-daemon 2>&1 | tee ../build_log.txt && exit 0 || echo "Failed attempt 3"
          echo "::endgroup::"
          
          # Fix per tentativo 4
          echo "::group::Fixing issues for attempt 4"
          if grep -q "Failed to create Jar file" ../build_log.txt; then
            rm -rf ~/.gradle/caches/jars-*/
            ./gradlew --stop
          elif grep -q "Namespace not specified" ../build_log.txt; then
            grep -B5 "Namespace not specified" ../build_log.txt | grep "project ':" | while read -r line; do
              MODULE=$(echo $line | sed "s/.*project ':\(.*\)'.*/\1/")
              MODULE_GRADLE="../node_modules/$MODULE/android/build.gradle"
              if [ -f "$MODULE_GRADLE" ] && ! grep -q "namespace" "$MODULE_GRADLE"; then
                NAMESPACE=$(echo $MODULE | sed 's/-/./g')
                sed -i "/android {/a\\    namespace \"com.${NAMESPACE}\"" "$MODULE_GRADLE"
              fi
            done
          fi
          echo "::endgroup::"
          
          # Tentativo 4
          echo "::group::Build Attempt 4/5"
          ./gradlew bundleRelease --stacktrace --no-daemon --refresh-dependencies 2>&1 | tee ../build_log.txt && exit 0 || echo "Failed attempt 4"
          echo "::endgroup::"
          
          # Fix per tentativo 5
          echo "::group::Fixing issues for attempt 5"
          if grep -q "Failed to create Jar file" ../build_log.txt; then
            rm -rf ~/.gradle/caches/jars-*/
            ./gradlew --stop
          elif grep -q "Namespace not specified" ../build_log.txt; then
            grep -B5 "Namespace not specified" ../build_log.txt | grep "project ':" | while read -r line; do
              MODULE=$(echo $line | sed "s/.*project ':\(.*\)'.*/\1/")
              MODULE_GRADLE="../node_modules/$MODULE/android/build.gradle"
              if [ -f "$MODULE_GRADLE" ] && ! grep -q "namespace" "$MODULE_GRADLE"; then
                NAMESPACE=$(echo $MODULE | sed 's/-/./g')
                sed -i "/android {/a\\    namespace \"com.${NAMESPACE}\"" "$MODULE_GRADLE"
              fi
            done
          fi
          echo "::endgroup::"
          
          # Tentativo 5
          echo "::group::Build Attempt 5/5"
          ./gradlew bundleRelease --stacktrace --no-daemon || exit 1
          echo "::endgroup::"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-build
          path: |
            android/app/build/outputs/bundle/release/*.aab
            android/app/build/outputs/apk/release/*.apk
            build_log.txt
          retention-days: 7
