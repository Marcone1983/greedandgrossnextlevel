name: simple build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          
      - run: npm install --legacy-peer-deps
      
      - name: Fix react-native-fs namespace
        run: |
          RNFS_BUILD_GRADLE="node_modules/react-native-fs/android/build.gradle"
          if [ -f "$RNFS_BUILD_GRADLE" ]; then
            sed -i '/android {/a\    namespace "com.rnfs"' "$RNFS_BUILD_GRADLE"
          fi
      
      - name: Setup Gradle Properties
        run: |
          mkdir -p android
          cat > android/gradle.properties << EOF
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.parallel=false
          org.gradle.configureondemand=false
          org.gradle.daemon=false
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.console=plain
          org.gradle.warning.mode=all
          org.gradle.logging.level=info
          EOF
      
      - run: chmod +x android/gradlew
      
      - name: Pre-download Gradle
        run: |
          cd android
          timeout 300 ./gradlew --version || true
      
      - name: Build with 5 attempts
        run: |
          cd android
          
          for attempt in 1 2 3 4 5; do
            echo "::group::Build Attempt $attempt/5"
            
            # Kill any hanging gradle processes
            pkill -f gradle || true
            
            # Prova il build con timeout di 10 minuti
            timeout 600 ./gradlew bundleRelease --stacktrace --no-daemon --no-parallel --info && {
              echo "✅ Build succeeded on attempt $attempt"
              echo "::endgroup::"
              exit 0
            } || {
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 124 ]; then
                echo "❌ Build timed out after 10 minutes"
              else
                echo "❌ Build failed with exit code $EXIT_CODE"
              fi
              echo "::endgroup::"
            }
            
            # Se siamo all'ultimo tentativo, esci
            if [ $attempt -eq 5 ]; then
              exit 1
            fi
            
            # Fix automatici
            echo "::group::Auto-fixing issues"
            
            if [ $attempt -eq 1 ]; then
              echo "Killing gradle and cleaning caches..."
              pkill -f gradle || true
              rm -rf ~/.gradle/daemon/
              rm -rf ~/.gradle/caches/jars-*/
              
            elif [ $attempt -eq 2 ]; then
              echo "Deep cleaning..."
              pkill -f gradle || true
              ./gradlew --stop || true
              rm -rf ~/.gradle/
              rm -rf build/ app/build/
              
            elif [ $attempt -eq 3 ]; then
              echo "Trying offline mode..."
              echo "org.gradle.offline=true" >> gradle.properties
              
            elif [ $attempt -eq 4 ]; then
              echo "Nuclear reset..."
              cd ..
              rm -rf android/.gradle android/build android/app/build
              rm -rf ~/.gradle
              cd android
            fi
            
            echo "::endgroup::"
            sleep 5
          done
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-build
          path: |
            android/app/build/outputs/bundle/release/*.aab
            android/app/build/outputs/apk/release/*.apk
